<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Printable Lesson</title>

<style>
body {
  font-family: 'Roboto Slab', serif;
  margin: 40px;
  color: #000;
}

h1, h2, h3 {
  page-break-after: avoid;
}

section {
  margin-bottom: 40px;
  page-break-inside: avoid;
}

.card {
  margin-bottom: 24px;
  page-break-inside: avoid;
}

@media print {
  body {
    margin: 20mm;
  }
}
</style>
</head>

<body>
<div id="content">Loading…</div>

<script>
const params = new URLSearchParams(window.location.search);
const unit = params.get("unit");
const lesson = params.get("lesson");

const DATA_URL =
  "https://raw.githubusercontent.com/zewolff1/yourhistory/main/usi/lesson-data.json";

function snakeToTitle(str) {
  return str.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
}

function buildFilePath(unit, lesson, group, card, filename) {
  const parts = [unit, lesson, group, card, filename].filter(Boolean);
  const base = "https://raw.githubusercontent.com/zewolff1/yourhistory/main/usi";
  return `${base}/${parts.join('/')}`;
}

async function fetchText(url) {
  const res = await fetch(url);
  return res.ok ? res.text() : "";
}

async function render() {
  const res = await fetch(DATA_URL);
  const data = await res.json();

  const lessonData = data[unit].lessons[lesson];
  const root = document.getElementById("content");

  root.innerHTML = `
    <h1>${snakeToTitle(unit)}</h1>
    <h2>${snakeToTitle(lesson)}</h2>
    <p><strong>Objectives:</strong> ${(lessonData.objectives || []).join(" • ")}</p>
  `;

  for (const groupName of Object.keys(lessonData.groups)) {
    const group = lessonData.groups[groupName];

    const section = document.createElement("section");
    section.innerHTML = `<h3>${snakeToTitle(groupName)}</h3>`;

    for (const cardName of Object.keys(group)) {
      const card = group[cardName];
      const writingUrl = buildFilePath(unit, lesson, groupName, cardName, card.writingFile || "writing");

      const text = await fetchText(writingUrl);

      const div = document.createElement("div");
      div.className = "card";
      div.innerHTML = `
        <h4>${card.title || snakeToTitle(cardName)}</h4>
        ${text}
      `;

      section.appendChild(div);
    }

    root.appendChild(section);
  }

  window.print(); // ✅ works here
}

render();
</script>
</body>
</html>
