# Generates usii/manifest.json by walking the usii/ folder and opens a PR if it changed.
# Single-file solution (no external script files required).
name: Generate usii manifest

on:
  push:
    paths:
      - 'usii/**'
      - '.github/workflows/generate-manifest.yml'
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate manifest (Python)
        run: |
          python - <<'PY'
          import json, os, re
          from pathlib import Path
          from datetime import datetime

          ROOT = Path('usii')
          OUT = ROOT / 'manifest.json'

          def strip_prefix(n):
              return re.sub(r'^\d+[_-]', '', n)
          def snake_to_title(n):
              return ' '.join(w.capitalize() for w in strip_prefix(n).replace('_',' ').split())

          ICON_NAMES = ['icon.png','icon.svg','icon.jpg','icon.jpeg','bgimage.png','bgimage.jpg','bgimage.jpeg']

          def find_first(path, names):
              for n in names:
                  p = path / n
                  if p.is_file(): return n
              return None

          def read_caption(path, basename):
              cap = path / f"{basename}.caption"
              if cap.exists():
                  try:
                      return cap.read_text(encoding='utf8').strip()
                  except:
                      return None
              return None

          def list_media_files(card_path):
              files = []
              if not card_path.exists(): return files
              for p in sorted(card_path.iterdir(), key=lambda x: x.name):
                  if p.is_file() and re.search(r'\.(png|jpe?g|mp4|svg)$', p.name, re.I) and not re.match(r'^bgimage\.', p.name, re.I):
                      typ = 'video' if p.name.lower().endswith('.mp4') else 'image'
                      base = re.sub(r'\.[^.]+$','', p.name)
                      caption = read_caption(card_path, base)
                      files.append({'name': p.name, 'type': typ, 'caption': caption or None})
              return files

          manifest = {'generated_at': datetime.utcnow().isoformat()+'Z', 'units': []}

          if not ROOT.exists():
              print("usii/ directory not found; writing empty manifest")
              ROOT.mkdir(parents=True, exist_ok=True)

          for unit in sorted([d for d in ROOT.iterdir() if d.is_dir()], key=lambda p: p.name):
              unit_icon = find_first(unit, ICON_NAMES)
              unit_obj = {
                  'name': unit.name,
                  'title': snake_to_title(unit.name),
                  'icon': str(Path('usii') / unit.name / unit_icon) if unit_icon else None,
                  'lessons': []
              }
              for lesson in sorted([d for d in unit.iterdir() if d.is_dir()], key=lambda p: p.name):
                  lesson_icon = find_first(lesson, ICON_NAMES)
                  lesson_obj = {
                      'name': lesson.name,
                      'title': snake_to_title(lesson.name),
                      'icon': str(Path('usii') / unit.name / lesson.name / lesson_icon) if lesson_icon else None,
                      'tabs': []
                  }
                  for tab in sorted([d for d in lesson.iterdir() if d.is_dir()], key=lambda p: p.name):
                      tab_icon = find_first(tab, ICON_NAMES)
                      tab_obj = {
                          'name': tab.name,
                          'title': snake_to_title(tab.name),
                          'icon': str(Path('usii') / unit.name / lesson.name / tab.name / tab_icon) if tab_icon else None,
                          'cards': []
                      }
                      for card in sorted([d for d in tab.iterdir() if d.is_dir()], key=lambda p: p.name):
                          bg = find_first(card, ['bgimage.png','bgimage.jpg','bgimage.jpeg'])
                          media = list_media_files(card)
                          has_writing = (card / 'writing').is_file()
                          card_obj = {
                              'name': card.name,
                              'title': snake_to_title(card.name),
                              'bgimage': str(Path('usii') / unit.name / lesson.name / tab.name / card.name / bg) if bg else None,
                              'has_writing': bool(has_writing),
                              'media': media
                          }
                          tab_obj['cards'].append(card_obj)
                      lesson_obj['tabs'].append(tab_obj)
                  unit_obj['lessons'].append(lesson_obj)
              manifest['units'].append(unit_obj)

          new_text = json.dumps(manifest, indent=2) + "\n"
          old_text = None
          if OUT.exists():
              try:
                  old_text = OUT.read_text(encoding='utf8')
              except:
                  old_text = None
          if old_text == new_text:
              print("UNCHANGED")
          else:
              OUT.parent.mkdir(parents=True, exist_ok=True)
              OUT.write_text(new_text, encoding='utf8')
              print(f"WROTE {OUT}")
          PY

      - name: Create PR with manifest changes (if any)
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: chore: update usii/manifest.json [skip ci]
          branch: update/manifest-${{ github.run_id }}
          title: chore: update usii/manifest.json
          body: Auto-generated manifest.json (CI)
          labels: autogenerated
          base: main
